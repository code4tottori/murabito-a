<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.16/vue.min.js" type="text/javascript"></script>
  <script src="./mqttws31.js" type="text/javascript"></script>
  <script>
  var MQTTClient = null;
  var MAP = null;
  var MARKERS = [];

  function onMqttMessage(message) {
    var data = null;
    try {
      data = JSON.parse(message.payloadString);
    } catch(e) {
      console.log(e, message.payloadString);
      return;
    }
    var location = data.location;
    if (location && location.lat && location.lon) {
      var latlng = new google.maps.LatLng(location.lat, location.lon);
      if (MARKERS[data.device]==null) {
        // http://www.ajaxtower.jp/googlemaps/gmarker/index1.html
        var marker = MARKERS[data.device] = new google.maps.Marker({
          map: MAP,
          position: latlng,
          title: data.device,
          clickable: true,
        });
        // https://developers.google.com/maps/documentation/javascript/examples/event-simple
        marker.addListener('click', function() {
          // MAP.setZoom(20);
          MAP.setCenter(marker.getPosition());
        });
      } else {
        MARKERS[data.device].setPosition(latlng);
      }
    } else {
      console.log("dropped: ", message.payloadString);
    }
  }

  function initialize() {
    var latlng = new google.maps.LatLng(35.515132, 134.1696503);
    MAP = new google.maps.Map(document.getElementById("map_canvas"), {
      zoom: 16,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/mqtturi", true);
    xhr.onload = function (e) {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          var endpoint = JSON.parse(xhr.responseText).uri;
          var clientId = Math.random().toString(36).substring(7);
          var connectOptions = {
            useSSL: true,
            timeout: 3,
            mqttVersion: 4,
            onSuccess: function() {
              MQTTClient.subscribe("murabito-a/moved");
              document.getElementById('status').innerHTML = "subscribed";
            }
          };
          MQTTClient = new Paho.MQTT.Client(endpoint, clientId);
          MQTTClient.connect(connectOptions);
          MQTTClient.onMessageArrived = onMqttMessage;
          MQTTClient.onConnectionLost = function(e) { console.log(e) };
        } else {
          document.getElementById('status').innerHTML = xhr.statusText;
        }
      }
    };
    xhr.onerror = function (e) {
      document.getElementById('status').innerHTML = xhr.statusText;
    };
    xhr.send(null);
  }
  </script>
</head>
<body onload="initialize()">
  <div id="map_canvas" style="width:720px; height:640px"></div>
  <div>
    こんなのをpublish
  </div>
  <div><code>
    {"device":"0BAD0194-53E0-434B-BFB5-D10F8A1B9B37","event":"MOVED", "location":{"lat":35.515132, "lon":134.1696503}}
  </code></div>
  <hr/>
  <div id="status">---</div>
</body>
</html>
