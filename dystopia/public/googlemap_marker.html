<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.16/vue.min.js" type="text/javascript"></script>
  <script src="//code.jquery.com/jquery-2.2.1.min.js" type="text/javascript"></script>
  <script src="//code.jquery.com/ui/1.10.3/jquery-ui.min.js" type="text/javascript"></script>
  <link href="//code.jquery.com/ui/1.10.3/themes/cupertino/jquery-ui.min.css" type="text/css" rel="stylesheet"/>
  <script src="./mqttws31.js" type="text/javascript"></script>
  <script>
  var MQTTClient = null;
  var MAP = null;
  var MARKERS = [];

  function appendNewPin(latlng, caree) {
    // http://www.ajaxtower.jp/googlemaps/gmarker/index1.html
    var marker = MARKERS[caree.id] = new google.maps.Marker({
      map: MAP,
      position: latlng,
      icon: caree.icon,
      title: caree.name,
      clickable: true,
    });
    marker['caree'] = caree;
    // https://developers.google.com/maps/documentation/javascript/examples/event-simple
    marker.addListener('click', function() {
      // MAP.setZoom(20);
      MAP.setCenter(marker.getPosition());
      showCareeDialog(marker.caree);
    });
  }

  function showCareeDialog(caree) {
    var ev = caree.last_event;
    $('#careeDialog .event').text(ev.event);
    $('#careeDialog .heartrate').text(ev.heartrate || "----");
    $('#careeDialog .location').text(ev.latitude+", "+ev.longitude+", "+(ev.altitude||""));
    $('#careeDialog').dialog({
      title: caree.name,
      modal: false,
      closeOnEscape: true,
      position: {
        of: "#map_canvas",
        at: "center",
        my: "left top"
      },
      show: 500,
      hide: 500
    });
  }

  function onMqttMessage(message) {
    var event = null;
    try {
      event = JSON.parse(message.payloadString);
    } catch(e) {
      console.log(e, message.payloadString);
      return;
    }
    var location = event.location;
    if (location && location.lat && location.lon) {
      var latlng = new google.maps.LatLng(location.lat, location.lon);
      if (MARKERS[event.caree_id]==null) {
        $.get("/carees/"+event.caree_id+".json", "", function(caree){
          appendNewPin(latlng, caree);
        }, "json");
      } else {
        MARKERS[event.caree_id].setPosition(latlng);
        MARKERS[event.caree_id].caree.last_event = {
          event: event.event,
          heartrate:  event.heartrate,
          latitude:   event.location ? event.location.lat : null,
          longitude:  event.location ? event.location.lon : null,
          altitude:   event.location ? event.location.alt : null,
          acceleration_x: event.acceleration ? event.acceleration.x : null,
          acceleration_y: event.acceleration ? event.acceleration.y : null,
          acceleration_y: event.acceleration ? event.acceleration.z : null,
        };
      }
    } else {
      console.log("dropped: ", message.payloadString);
    }
  }

  function connectMQTT() {
    $.get("/mqtturi", "", function(resp){
      var endpoint = resp.uri;
      var clientId = Math.random().toString(36).substring(7);
      var connectOptions = {
        useSSL: true,
        timeout: 3,
        mqttVersion: 4,
        onSuccess: function() {
          MQTTClient.subscribe("murabito-a/moved");
          document.getElementById('status').innerHTML = "subscribed";
        }
      };
      MQTTClient = new Paho.MQTT.Client(endpoint, clientId);
      MQTTClient.connect(connectOptions);
      MQTTClient.onMessageArrived = onMqttMessage;
      MQTTClient.onConnectionLost = function(e) {
        console.log("MQTTClient.onConnectionLost", e);
        document.getElementById('status').innerHTML = "DISCONNECT";
        setTimeout(function() {
          connectMQTT();
        }, 1);
      };
    }, "json");
  }

  function initialize() {
    var latlng = new google.maps.LatLng(35.515132, 134.1696503);
    MAP = new google.maps.Map(document.getElementById("map_canvas"), {
      zoom: 16,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    $.get("/carees.json", "", function(carees){
      carees.forEach(function(caree,index,arr){
        console.log("loading: ", caree.name, caree.last_event);
        if (caree.last_event && caree.last_event.latitude && caree.last_event.longitude) {
          var latlng = new google.maps.LatLng(caree.last_event.latitude, caree.last_event.longitude);
          appendNewPin(latlng, caree);
        }
      });
    });
    connectMQTT();
  }
  </script>
</head>
<body onload="initialize()">
  <div id="map_canvas" style="width:720px; height:640px"></div>
  <div>
    こんなのをpublish
  </div>
  <div><code>
    {"caree_id":1,"event":"MOVED", "location":{"lat":35.515132, "lon":134.1696503}}
  </code></div>
  <hr/>
  <div id="status">---</div>
  <div id="careeDialog" title="--name--">
    <div class="event"></div>
    <div class="location"></div>
    <div class="heartrate"></div>
  </div>
  <hr/>
  <a href="/device.html">for Publish from phones</a>
</body>
</html>
